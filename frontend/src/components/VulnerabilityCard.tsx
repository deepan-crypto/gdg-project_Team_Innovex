import { AlertTriangle, Info, FileCode, Lightbulb, Shield, ExternalLink } from 'lucide-react';
import type { Vulnerability } from '../types/scan';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
}

const severityConfig = {
  critical: {
    bg: 'bg-red-50',
    border: 'border-red-300',
    text: 'text-red-800',
    badge: 'bg-red-600',
    icon: 'text-red-600',
  },
  high: {
    bg: 'bg-orange-50',
    border: 'border-orange-300',
    text: 'text-orange-800',
    badge: 'bg-orange-600',
    icon: 'text-orange-600',
  },
  medium: {
    bg: 'bg-yellow-50',
    border: 'border-yellow-300',
    text: 'text-yellow-800',
    badge: 'bg-yellow-600',
    icon: 'text-yellow-600',
  },
  low: {
    bg: 'bg-blue-50',
    border: 'border-blue-300',
    text: 'text-blue-800',
    badge: 'bg-blue-600',
    icon: 'text-blue-600',
  },
  info: {
    bg: 'bg-slate-50',
    border: 'border-slate-300',
    text: 'text-slate-800',
    badge: 'bg-slate-600',
    icon: 'text-slate-600',
  },
};

const typeLabels: Record<string, string> = {
  prompt_injection: 'Prompt Injection',
  hardcoded_secrets: 'Hardcoded Secrets',
  sql_injection: 'SQL Injection',
  xss: 'XSS Vulnerability',
  dependency: 'Dependency Issue',
  unsafe_llm_output: 'Unsafe LLM Output',
  jailbreak: 'LLM Jailbreak',
  encoding_attack: 'Encoding Attack',
  latent_injection: 'Latent Injection',
  malware: 'Malware Pattern',
  dan_attack: 'DAN Attack',
  shell_execution: 'Shell Execution',
  data_exfiltration: 'Data Exfiltration',
};

export default function VulnerabilityCard({ vulnerability }: VulnerabilityCardProps) {
  const config = severityConfig[vulnerability.severity];

  return (
    <div className={`${config.bg} border-2 ${config.border} rounded-xl p-6 space-y-4`}>
      <div className="flex items-start justify-between">
        <div className="flex items-start space-x-3">
          <AlertTriangle className={`w-6 h-6 ${config.icon} flex-shrink-0 mt-1`} />
          <div>
            <h3 className="text-xl font-bold text-slate-900 mb-1">
              {vulnerability.title}
            </h3>
            <p className={`text-sm font-medium ${config.text}`}>
              {typeLabels[vulnerability.type]}
            </p>
          </div>
        </div>
        <span className={`${config.badge} text-white text-xs font-bold px-3 py-1 rounded-full uppercase`}>
          {vulnerability.severity}
        </span>
      </div>

      <p className="text-slate-700 leading-relaxed">
        {vulnerability.description}
      </p>

      <div className="space-y-3">
        <div className="flex items-start space-x-2">
          <FileCode className="w-5 h-5 text-slate-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <span className="font-semibold text-slate-700">Location:</span>{' '}
            <span className="text-slate-600">
              {vulnerability.file_path}:{vulnerability.line_number}
            </span>
          </div>
        </div>
      </div>

      <div className="bg-slate-900 rounded-lg p-4 overflow-x-auto">
        <pre className="text-sm text-slate-100 font-mono">
          <code>{vulnerability.code_snippet}</code>
        </pre>
      </div>

      <div className="space-y-4 pt-2">
        <div className="bg-white/50 rounded-lg p-4">
          <div className="flex items-start space-x-2 mb-2">
            <Info className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
            <h4 className="font-semibold text-slate-900">Why is this dangerous?</h4>
          </div>
          <p className="text-slate-700 text-sm leading-relaxed ml-7">
            {vulnerability.explanation}
          </p>
        </div>

        <div className="bg-white/50 rounded-lg p-4">
          <div className="flex items-start space-x-2 mb-2">
            <AlertTriangle className="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" />
            <h4 className="font-semibold text-slate-900">Risk</h4>
          </div>
          <p className="text-slate-700 text-sm leading-relaxed ml-7">
            {vulnerability.risk}
          </p>
        </div>

        <div className="bg-white/50 rounded-lg p-4">
          <div className="flex items-start space-x-2 mb-2">
            <Lightbulb className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
            <h4 className="font-semibold text-slate-900">How to fix it</h4>
          </div>
          <p className="text-slate-700 text-sm leading-relaxed ml-7 whitespace-pre-wrap">
            {vulnerability.fix}
          </p>
        </div>

        {vulnerability.references && vulnerability.references.length > 0 && (
          <div className="bg-white/50 rounded-lg p-4">
            <div className="flex items-start space-x-2 mb-2">
              <Shield className="w-5 h-5 text-slate-600 flex-shrink-0 mt-0.5" />
              <h4 className="font-semibold text-slate-900">Learn More</h4>
            </div>
            <div className="ml-7 space-y-1">
              {vulnerability.references.map((ref, idx) => (
                <a
                  key={idx}
                  href={ref}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-600 hover:text-blue-700 text-sm flex items-center space-x-1"
                >
                  <ExternalLink className="w-3 h-3" />
                  <span>{ref}</span>
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
